{% extends 'index.html' %}
{% load static %}

{% block title %}{{ pos.name }}{% endblock %}

{% block content %}
    <style>
        @media screen and (max-width: 980px) {
            .nav-title {
                color: #0C0C0D7A;
                font-size: 26px;
                font-weight: 600;
                margin-left: 12px;
                width: 240px;
            }
        }
    </style>
    <nav class="nav">
        <div class="nav-left">
            <a class="" href="#"><img src="{% static 'images/header.svg' %}" style="width: 104px;"></a>
            <div class="nav-title" id="" href="#" style="margin-left: 5%">Экспресс печать</div>
        </div>
    </nav>

    <div align="center" style="margin-top: 5%">
        <h2 class="middle" style="color: black;margin-bottom: 1rem;">Экспресс печать в {{ pos.name }}</h2>
    </div>
    <style>
        .input-group {
            min-height: 58px;
        }

        .form-control {
            background-color: #23232A14;
            border-radius: 12px;
        }

        .input-group-text {
            border: 0;
            border-radius: 12px;
            background-color: #23232A14;
        }
    </style>
    <div style="padding: 4%">
        <label class="semi f-16 grey">Тариф</label>
        <div style="padding: 1rem; background: #FFFFFF;box-shadow: 0 16px 32px -16px rgb(0 0 0 / 8%);border-radius: 16px;">
            <div class="div-price-item" style="margin-bottom: 0">
                <h2 class="middle" style="color: black;">{{ rate.price_per_list }} ₽ страница</h2>
            </div>
        </div>
    </div>
    <div style="padding: 4%">
        <div style="padding: 5%; background: #FFFFFF;box-shadow: 0px 16px 32px -16px rgb(0 0 0 / 8%);border-radius: 16px;">
            <div id="file-input">
                {% csrf_token %}
                <div id="file1">
                    <div class="input-group mb-3">
                        <input type="file" class="form-control" accept="application/pdf,application/msword,
  application/vnd.openxmlformats-officedocument.wordprocessingml.document" name="file1" id="inputGroupFile02"
                               style="padding: 1rem 0.75rem;">
                    </div>
                    <div class="input-group mb-3 ls">
                        <span class="input-group-text">Количество копий</span>
                        <input type="text" name="copy1" value="1" class="form-control">
                    </div>
                </div>
            </div>
            <button id="send" disabled class="btn btn-next bold">Отправить на печать</button>
        </div>
    </div>

    <div style="display: flex;flex-direction: column;padding: 4%;">
        {#================================================== Схема==================#}
        <div align="center" class="div-choice-delivery-company">
            <label class="semi f-16 grey" style="margin-bottom: 1.55%">Местоположение</label>
            <label class="bold f-16 black" style="margin-bottom: 4.64%">Терминал А, 2 этаж.<br>
                Возле стойки информации.</label>
            <img src="{% static 'images/scheme.png' %}">
        </div>
    </div>

{% endblock %}



{% block script %}

    <script>
        jQuery(function () {
            var massFile = {}
            var count = 1
            var socket = new WebSocket(
                "ws://" + window.location.host + "/ws/" + {{ pos.id }}
            );
            $('body').on('change', 'input[type="file"]', function () {

                var name = $(this).attr('name')
                if (typeof massFile[name] !== 'undefined' && $(this).val() === "" && count !== 1) {
                    $('#file' + (count)).remove()
                    delete massFile[name];
                    count--;
                } else if (typeof massFile[name] !== "undefined" && $(this).val() != "") {
                    massFile[name] = $(this).val();
                } else if (typeof massFile[name] === 'undefined') {
                    massFile[name] = $(this).val();
                    count++;
                    var html = `<hr/><div id="file${count}" ><div class="input-group mb-3">
                            <input type="file" class="form-control" accept="application/pdf,application/msword,
                                  application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                name="file${count}" style="padding: 1rem 0.75rem;">
                        </div>
                        <div class="input-group mb-3 ls">
                            <span class="input-group-text">Количество копий</span>
                            <input type="text" name="copy${count}" value="1" class="form-control">
                        </div></div>`;
                    $('#file' + (count - 1)).after(html);
                }
                console.log(count, massFile, count === 1 && massFile[Object.keys(massFile)[0]] == "")
                if (count === 1){
                    $('#send').attr('disabled','disabled')
                }else{
                    $('#send').removeAttr('disabled')
                }

            });

            $('#send').click(function () {
                var formData = new FormData();
                for (var key in massFile) {
                    console.log($('input[name="' + key + '"]')[0].files[0])
                    formData.append(key, $('input[name="' + key + '"]')[0].files[0])
                }

                $('input[type="text"]').each(function () {
                    formData.append($(this).attr('name'), $(this).val())
                });

                formData.append("csrfmiddlewaretoken", $('input[name="csrfmiddlewaretoken"]').val())

                formData.append('pos', {{ pos.id }})

                $.ajax({
                    type: "POST",
                    url: 'create_order',
                    cache: false,
                    contentType: false,
                    processData: false,
                    data: formData,
                    dataType: 'json',
                    success: function (data) {
                        socket.send(JSON.stringify(data));
                        document.location.href = document.location.origin + '/user/'+ {{ pos.id }} +'/success_create/' + data.date + '/' + data.num
                    }
                });

            });


        });
    </script>
{% endblock %}